<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background-color: #0B0B0B; color: #D6B15A; font-family: 'Segoe UI', sans-serif; padding-bottom: 180px; }
    .header-section { background: linear-gradient(135deg, #171717 0%, #3A2B1C 100%); padding: 25px 15px; border-bottom: 2px solid #B08A3A; text-align: center; }
    .logo-img { max-height: 80px; margin-bottom: 10px; }
    .menu-item { background: #171717; border: 1px solid #3A2B1C; border-radius: 15px; padding: 15px; margin-bottom: 12px; }
    .price-tag { color: #8A6A2E; font-weight: bold; font-size: 0.95rem; }
    .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #B08A3A; background: transparent; color: #D6B15A; font-weight: bold; }
    .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #171717; padding: 20px 20px 30px 20px; border-top: 1px solid #B08A3A; z-index: 1000; box-shadow: 0 -10px 25px rgba(0,0,0,0.9); }
    .form-control { background: #0B0B0B !important; border: 2px solid #D6B15A !important; color: #FFFFFF !important; font-weight: bold; font-size: 16px !important; }
    .token-card { background: #171717; border: 2px solid #B08A3A; border-radius: 20px; padding: 30px; }
    .token-number { font-size: 3.5rem; font-weight: 900; color: #D6B15A; display: block; letter-spacing: 2px; }
    #customModal, #confirmModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; }
    .modal-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #171717; border: 2px solid #D6B15A; padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 400px; }
    .btn-gold { background: #D6B15A; color: #000; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="app-container">
    <div class="header-section"><img src="https://i.postimg.cc/QxvSm9mc/Twist-Toast.jpg" class="logo-img" alt="Logo"><h4 class="mb-0">TWIST & TOAST</h4></div>
    <div class="container mt-3" id="menu-list"><div class="text-center p-5"><h4 id="loadTxt">Loading Menu...</h4></div></div>
    <div class="footer-bar">
      <input type="text" id="studentName" class="form-control mb-2" placeholder="TAP TO ENTER NAME">
      <input type="tel" id="studentPhone" class="form-control mb-2" placeholder="PHONE NUMBER">
      <select id="payMethod" class="form-select mb-3" style="background:#0B0B0B; color:#D6B15A; border:1px solid #B08A3A;"><option value="UPI">Pay via UPI</option></select>
      <button onclick="handleOrder()" id="mainBtn" class="btn btn-warning w-100 fw-bold" disabled style="background:#D6B15A; color:#000;">Select Items</button>
    </div>
  </div>

  <div id="customModal"><div class="modal-box"><h4 style="color:#D6B15A;">Name Required</h4><p style="color:#fff; margin:20px 0;">Please enter your name.</p><button onclick="closeModal()" class="btn-gold">GOT IT</button></div></div>
  <div id="confirmModal"><div class="modal-box"><h4 style="color:#D6B15A;">Finalize Order</h4><p style="color:#fff; margin:20px 0;">Kitchen will begin prep after payment verification.</p>
      <div class="d-flex gap-2 justify-content-center"><button onclick="proceedOrder()" class="btn-gold">PAY & PLACE</button><button onclick="closeConfirmModal()" class="btn btn-outline-secondary" style="color:#fff; border-color:#D6B15A;">Cancel</button></div>
  </div></div>

  <script>
    var UPI_ID = "yespay.bizsbiz121539@yesbankltd";
    var menuData = [], cart = {}, pollInterval;

    window.onload = function () {
      var saved = localStorage.getItem('lastTokenHtml'), orderTime = localStorage.getItem('tokenTimestamp'), savedToken = localStorage.getItem('activeToken');
      if (saved && orderTime && (new Date().getTime() - orderTime < 900000)) {
        document.getElementById('app-container').innerHTML = saved;
        if (savedToken) startPolling(savedToken);
      } else {
        google.script.run.withSuccessHandler(showMenu).withFailureHandler(() => { document.getElementById('loadTxt').innerText="Error: Check Spreadsheet name"; }).getMenu();
      }
    };

    function showMenu(data) {
      if (!data || data.length === 0) { document.getElementById('menu-list').innerHTML = "<h4>Menu Empty</h4>"; return; }
      menuData = data; var html = '';
      data.forEach((item, i) => {
        html += `<div class="menu-item d-flex justify-content-between align-items-center">
          <div><div class="fw-bold">${item.name}</div><div class="price-tag">₹${item.price}</div></div>
          <div class="d-flex align-items-center gap-2">
            <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button><span id="qty-${i}">0</span><button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
          </div></div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function updateQty(i, c) {
      cart[i] = Math.max(0, (cart[i] || 0) + c); document.getElementById('qty-' + i).innerText = cart[i];
      var total = 0, has = false; for (var k in cart) { if (cart[k] > 0) { total += cart[k] * menuData[k].price; has = true; } }
      document.getElementById('mainBtn').disabled = !has; document.getElementById('mainBtn').innerText = has ? ("Order ₹" + total) : "Select Items";
    }

    function closeModal() { document.getElementById('customModal').style.display = 'none'; }
    function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }
    function handleOrder() {
      if (!document.getElementById('studentName').value.trim()) { document.getElementById('customModal').style.display = 'block'; return; }
      if (!/^[0-9]{10}$/.test(document.getElementById('studentPhone').value.trim())) { alert("Valid Phone Required"); return; }
      document.getElementById('confirmModal').style.display = 'block';
    }

    function proceedOrder() {
      closeConfirmModal();
      var name = document.getElementById('studentName').value.trim(), phone = document.getElementById('studentPhone').value.trim(), method = document.getElementById('payMethod').value;
      var total = 0, summaryHtml = "", itemsList = [];
      for (var k in cart) { if (cart[k] > 0) { total += cart[k] * menuData[k].price; itemsList.push(cart[k] + "x " + menuData[k].name); summaryHtml += "<li>" + cart[k] + "x " + menuData[k].name + "</li>"; } }
      if (method === "UPI") retryUPI(total);
      document.getElementById('mainBtn').innerText = "Processing...";
      google.script.run.withSuccessHandler(token => {
        var retryBtn = (method === "UPI") ? `<button onclick="retryUPI(${total})" class="btn btn-outline-warning w-100 mt-3" style="color:#D6B15A; border-color:#D6B15A;">Retry Payment</button>` : '';
        var successHtml = `<div class="container text-center py-4"><div class="token-card shadow p-4">
          <h3 class="text-warning fw-bold">ORDER RECEIVED</h3><span class="token-number">#${token}</span>
          <div class="text-start p-3 rounded-3 mt-4" style="color:#D6B15A; border:1px solid #3A2B1C; background:#0B0B0B">
            <strong>Name: <span style="color:#fff">${name}</span></strong><br>
            <strong>Status: <span id="stTxt" style="color:#fff">Waiting for Verification</span></strong><br>
            <ul class="mt-2">${summaryHtml}</ul><strong>Total: ₹${total}</strong>
          </div>${retryBtn}<button onclick="clearCache()" class="btn-gold mt-4 w-100">New Order</button></div></div>`;
        localStorage.setItem('lastTokenHtml', successHtml); localStorage.setItem('activeToken', token); localStorage.setItem('tokenTimestamp', new Date().getTime());
        document.getElementById('app-container').innerHTML = successHtml; startPolling(token);
      }).processOrder({ name: name, phone: phone, items: itemsList.join(", "), total: total, method: method });
    }

    function retryUPI(amt) { window.location.href = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=TWIST%20TOAST&am=${amt}&cu=INR`; }
    function startPolling(t) { pollInterval = setInterval(() => { google.script.run.withSuccessHandler(s => { if(document.getElementById('stTxt')) document.getElementById('stTxt').innerText = s; if(s==="Ready") showReady(t); if(s==="Delivered") clearCache(); }).checkOrderStatus(t); }, 15000); }
    function showReady(t) {
      var readyHtml = `<div class="container text-center py-5"><div class="token-card ready-state shadow p-4"><h1>✅</h1><h2 class="fw-bold" style="color:#fff">FOOD IS READY!</h2><span class="token-number" style="color:#fff">#${t}</span><button onclick="clearCache()" class="btn btn-light mt-4 fw-bold">ORDER AGAIN</button></div></div>`;
      document.getElementById('app-container').innerHTML = readyHtml; new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); localStorage.setItem('lastTokenHtml', readyHtml);
    }
    function clearCache() { if (pollInterval) clearInterval(pollInterval); localStorage.clear(); location.reload(); }
  </script>
</body>
</html>